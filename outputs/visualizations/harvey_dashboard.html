<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harvey CDBG-DR Funding Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 3rem;
            padding: 1.5rem;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c5282;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background: #edf2f7;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .section-header h2 {
            font-size: 1.25rem;
            color: #2d3748;
        }

        .section-content {
            padding: 1.5rem;
        }

        #sankey-chart {
            width: 100%;
            min-height: 500px;
        }

        #timeline-chart {
            width: 100%;
            height: 350px;
        }

        #county-chart {
            width: 100%;
            height: 400px;
        }

        .node rect {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 1px;
        }

        .node text {
            font-size: 12px;
            fill: #333;
        }

        .link {
            fill: none;
            stroke-opacity: 0.4;
        }

        .link:hover {
            stroke-opacity: 0.7;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
        }

        .tooltip .title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .tooltip .value {
            color: #90cdf4;
        }

        .legend {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            padding: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .bar {
            transition: opacity 0.2s;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .grid line {
            stroke: #e2e8f0;
        }

        .axis text {
            font-size: 11px;
            fill: #666;
        }

        .axis path,
        .axis line {
            stroke: #cbd5e0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .amount {
            font-family: 'SF Mono', Monaco, monospace;
            text-align: right;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            color: #666;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #2c5282;
        }

        .tab.active {
            color: #2c5282;
            border-bottom-color: #2c5282;
            font-weight: 600;
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-size: 0.9rem;
        }

        .footer a {
            color: #2c5282;
        }

        @media (max-width: 768px) {
            .stats-bar {
                flex-wrap: wrap;
                gap: 1.5rem;
            }

            .stat-value {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Hurricane Harvey CDBG-DR Funding Dashboard</h1>
        <p class="subtitle">Tracking $4.47 Billion in Disaster Recovery Funding Flows</p>
    </div>

    <div class="stats-bar">
        <div class="stat">
            <div class="stat-value" id="total-budget">$4.47B</div>
            <div class="stat-label">Total Budget</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="total-activities">616</div>
            <div class="stat-label">Activities</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="total-counties">62</div>
            <div class="stat-label">Counties</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="completion-rate">12.5%</div>
            <div class="stat-label">Completion Rate</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="current-quarter">Q4 2025</div>
            <div class="stat-label">Latest Quarter</div>
        </div>
    </div>

    <div class="container">
        <!-- Sankey Diagram -->
        <div class="section">
            <div class="section-header">
                <h2>Funding Flow: HUD → Texas GLO → Programs → Recipients</h2>
            </div>
            <div class="section-content">
                <div id="sankey-chart"></div>
                <div class="legend" id="sankey-legend"></div>
            </div>
        </div>

        <!-- Timeline Chart -->
        <div class="section">
            <div class="section-header">
                <h2>Quarterly Budget Trends</h2>
            </div>
            <div class="section-content">
                <div class="tabs">
                    <div class="tab active" data-view="budget">Budget</div>
                    <div class="tab" data-view="activities">Activity Count</div>
                    <div class="tab" data-view="completion">Completion</div>
                </div>
                <div id="timeline-chart"></div>
            </div>
        </div>

        <!-- County Distribution -->
        <div class="section">
            <div class="section-header">
                <h2>Top Counties by Funding Allocation</h2>
            </div>
            <div class="section-content">
                <div id="county-chart"></div>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="section">
            <div class="section-header">
                <h2>Organization Allocations</h2>
            </div>
            <div class="section-content">
                <table class="data-table" id="org-table">
                    <thead>
                        <tr>
                            <th>Organization</th>
                            <th>Program</th>
                            <th class="amount">Allocated</th>
                            <th class="amount">Activities</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Data Source: Texas GLO DRGR Reports | Generated by <a href="https://github.com/jrandre2/texas-glo-nlp">Texas GLO NLP Project</a></p>
    </div>

    <div class="tooltip" id="tooltip" style="display: none;"></div>

    <script>
        // Data will be loaded from JSON files
        let sankeyData = null;
        let trendsData = null;
        let hierarchyData = null;

        // Color scales
        const colors = {
            hud: '#1a365d',
            glo: '#2c5282',
            infrastructure: '#38a169',
            housing: '#d69e2e',
            organization: '#805ad5',
            county: '#dd6b20'
        };

        const programColors = {
            'Infrastructure': '#38a169',
            'Housing': '#d69e2e'
        };

        // Format currency
        function formatCurrency(value) {
            if (value >= 1e9) return '$' + (value / 1e9).toFixed(2) + 'B';
            if (value >= 1e6) return '$' + (value / 1e6).toFixed(1) + 'M';
            if (value >= 1e3) return '$' + (value / 1e3).toFixed(0) + 'K';
            return '$' + value.toFixed(0);
        }

        // Tooltip
        const tooltip = d3.select('#tooltip');

        function showTooltip(event, html) {
            tooltip
                .style('display', 'block')
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .html(html);
        }

        function hideTooltip() {
            tooltip.style('display', 'none');
        }

        // Draw Sankey Diagram
        function drawSankey(data) {
            const container = d3.select('#sankey-chart');
            container.selectAll('*').remove();

            const width = container.node().getBoundingClientRect().width;
            const height = 500;
            const margin = { top: 20, right: 200, bottom: 20, left: 20 };

            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create node index map
            const nodeMap = new Map(data.nodes.map((d, i) => [d.id, i]));

            // Create links with numeric indices
            const links = data.links.map(d => ({
                source: nodeMap.get(d.source),
                target: nodeMap.get(d.target),
                value: d.value,
                sourceName: d.source,
                targetName: d.target
            }));

            // Create sankey generator
            const sankey = d3.sankey()
                .nodeId(d => d.id)
                .nodeWidth(20)
                .nodePadding(20)
                .extent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]]);

            // Generate layout
            const graph = sankey({
                nodes: data.nodes.map(d => ({...d})),
                links: links.map(d => ({...d}))
            });

            // Color by level
            function nodeColor(d) {
                if (d.id === 'HUD') return colors.hud;
                if (d.id === 'Texas GLO') return colors.glo;
                if (d.id === 'Infrastructure') return colors.infrastructure;
                if (d.id === 'Housing') return colors.housing;
                if (d.level === 3) return colors.organization;
                return colors.county;
            }

            // Draw links
            svg.append('g')
                .selectAll('path')
                .data(graph.links)
                .join('path')
                .attr('class', 'link')
                .attr('d', d3.sankeyLinkHorizontal())
                .attr('stroke', d => nodeColor(graph.nodes[d.source.index]))
                .attr('stroke-width', d => Math.max(1, d.width))
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('stroke-opacity', 0.7);
                    showTooltip(event, `
                        <div class="title">${d.source.id} → ${d.target.id}</div>
                        <div class="value">${formatCurrency(d.value)}</div>
                    `);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('stroke-opacity', 0.4);
                    hideTooltip();
                });

            // Draw nodes
            const node = svg.append('g')
                .selectAll('g')
                .data(graph.nodes)
                .join('g');

            node.append('rect')
                .attr('x', d => d.x0)
                .attr('y', d => d.y0)
                .attr('height', d => d.y1 - d.y0)
                .attr('width', d => d.x1 - d.x0)
                .attr('fill', nodeColor)
                .on('mouseover', function(event, d) {
                    showTooltip(event, `
                        <div class="title">${d.id}</div>
                        <div class="value">${formatCurrency(d.value)}</div>
                    `);
                })
                .on('mouseout', hideTooltip);

            // Node labels
            node.append('text')
                .attr('x', d => d.x1 + 6)
                .attr('y', d => (d.y1 + d.y0) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'start')
                .text(d => `${d.id}: ${formatCurrency(d.value)}`)
                .style('font-size', '12px')
                .style('fill', '#333');
        }

        // Draw Timeline Chart
        function drawTimeline(data, view = 'budget') {
            const container = d3.select('#timeline-chart');
            container.selectAll('*').remove();

            const width = container.node().getBoundingClientRect().width;
            const height = 350;
            const margin = { top: 30, right: 120, bottom: 60, left: 80 };

            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);

            // Process data by quarter
            const quarters = [...new Set(data.map(d => d.quarter))].sort();
            const programs = ['Infrastructure', 'Housing'];

            // Aggregate data
            const aggregated = quarters.map(q => {
                const qData = data.filter(d => d.quarter === q);
                const result = { quarter: q };
                programs.forEach(p => {
                    const pData = qData.find(d => d.program_type === p) || {};
                    result[p] = {
                        budget: pData.total_budget || 0,
                        activities: pData.activity_count || 0,
                        completed: pData.completed || 0
                    };
                });
                return result;
            });

            // Get values based on view
            function getValue(d, program) {
                if (view === 'budget') return d[program].budget;
                if (view === 'activities') return d[program].activities;
                if (view === 'completion') return d[program].completed;
                return 0;
            }

            // Scales
            const x = d3.scaleBand()
                .domain(quarters)
                .range([margin.left, width - margin.right])
                .padding(0.2);

            const maxValue = d3.max(aggregated, d =>
                d3.max(programs, p => getValue(d, p))
            );

            const y = d3.scaleLinear()
                .domain([0, maxValue * 1.1])
                .range([height - margin.bottom, margin.top]);

            // Grid
            svg.append('g')
                .attr('class', 'grid')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(y)
                    .tickSize(-(width - margin.left - margin.right))
                    .tickFormat('')
                );

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .attr('text-anchor', 'end')
                .attr('dx', '-0.5em')
                .attr('dy', '0.5em');

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(y).tickFormat(d => {
                    if (view === 'budget') return formatCurrency(d);
                    return d;
                }));

            // Draw lines for each program
            const line = d3.line()
                .x(d => x(d.quarter) + x.bandwidth() / 2)
                .y(d => y(d.value))
                .curve(d3.curveMonotoneX);

            programs.forEach(program => {
                const lineData = aggregated.map(d => ({
                    quarter: d.quarter,
                    value: getValue(d, program)
                }));

                svg.append('path')
                    .datum(lineData)
                    .attr('fill', 'none')
                    .attr('stroke', programColors[program])
                    .attr('stroke-width', 3)
                    .attr('d', line);

                // Add dots
                svg.selectAll(`.dot-${program}`)
                    .data(lineData)
                    .join('circle')
                    .attr('class', `dot-${program}`)
                    .attr('cx', d => x(d.quarter) + x.bandwidth() / 2)
                    .attr('cy', d => y(d.value))
                    .attr('r', 5)
                    .attr('fill', programColors[program])
                    .on('mouseover', function(event, d) {
                        showTooltip(event, `
                            <div class="title">${d.quarter} - ${program}</div>
                            <div class="value">${view === 'budget' ? formatCurrency(d.value) : d.value}</div>
                        `);
                    })
                    .on('mouseout', hideTooltip);
            });

            // Legend
            const legend = svg.append('g')
                .attr('transform', `translate(${width - margin.right + 20}, ${margin.top})`);

            programs.forEach((program, i) => {
                const g = legend.append('g')
                    .attr('transform', `translate(0, ${i * 25})`);

                g.append('rect')
                    .attr('width', 16)
                    .attr('height', 16)
                    .attr('fill', programColors[program]);

                g.append('text')
                    .attr('x', 22)
                    .attr('y', 12)
                    .text(program)
                    .style('font-size', '12px');
            });
        }

        // Draw County Bar Chart
        function drawCountyChart(data) {
            const container = d3.select('#county-chart');
            container.selectAll('*').remove();

            // Filter and sort top counties
            const countyData = data
                .filter(d => d.county && d.county !== 'Statewide')
                .reduce((acc, d) => {
                    if (!acc[d.county]) acc[d.county] = { county: d.county, allocated: 0, activities: 0 };
                    acc[d.county].allocated += d.allocated || 0;
                    acc[d.county].activities += d.activity_count || 0;
                    return acc;
                }, {});

            const sortedData = Object.values(countyData)
                .sort((a, b) => b.allocated - a.allocated)
                .slice(0, 15);

            const width = container.node().getBoundingClientRect().width;
            const height = 400;
            const margin = { top: 20, right: 120, bottom: 40, left: 150 };

            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);

            // Scales
            const y = d3.scaleBand()
                .domain(sortedData.map(d => d.county))
                .range([margin.top, height - margin.bottom])
                .padding(0.2);

            const x = d3.scaleLinear()
                .domain([0, d3.max(sortedData, d => d.allocated) * 1.1])
                .range([margin.left, width - margin.right]);

            // Grid
            svg.append('g')
                .attr('class', 'grid')
                .attr('transform', `translate(0,${margin.top})`)
                .call(d3.axisTop(x)
                    .tickSize(-(height - margin.top - margin.bottom))
                    .tickFormat('')
                );

            // Bars
            svg.selectAll('.bar')
                .data(sortedData)
                .join('rect')
                .attr('class', 'bar')
                .attr('y', d => y(d.county))
                .attr('x', margin.left)
                .attr('height', y.bandwidth())
                .attr('width', d => x(d.allocated) - margin.left)
                .attr('fill', colors.county)
                .on('mouseover', function(event, d) {
                    showTooltip(event, `
                        <div class="title">${d.county}</div>
                        <div class="value">${formatCurrency(d.allocated)}</div>
                        <div>${d.activities} activities</div>
                    `);
                })
                .on('mouseout', hideTooltip);

            // Value labels
            svg.selectAll('.value-label')
                .data(sortedData)
                .join('text')
                .attr('class', 'value-label')
                .attr('y', d => y(d.county) + y.bandwidth() / 2)
                .attr('x', d => x(d.allocated) + 5)
                .attr('dy', '0.35em')
                .text(d => formatCurrency(d.allocated))
                .style('font-size', '11px')
                .style('fill', '#666');

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(y));

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).tickFormat(formatCurrency));
        }

        // Populate organization table
        function populateOrgTable(data) {
            const tbody = d3.select('#org-table tbody');
            tbody.selectAll('*').remove();

            // Aggregate and sort
            const sorted = data
                .filter(d => d.responsible_org)
                .sort((a, b) => (b.allocated || 0) - (a.allocated || 0))
                .slice(0, 10);

            sorted.forEach(d => {
                const tr = tbody.append('tr');
                tr.append('td').text(d.responsible_org);
                tr.append('td').text(d.program_type || 'Mixed');
                tr.append('td').attr('class', 'amount').text(formatCurrency(d.allocated || 0));
                tr.append('td').attr('class', 'amount').text(d.activity_count || 0);
            });
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                if (trendsData) {
                    drawTimeline(trendsData, this.dataset.view);
                }
            });
        });

        // Load data and initialize
        async function init() {
            try {
                // Try loading from same directory first (for local viewing)
                const basePath = '../exports/';

                // Load Sankey data
                const sankeyResponse = await fetch(basePath + 'harvey_sankey_data.json');
                sankeyData = await sankeyResponse.json();

                // Load trends data
                const trendsResponse = await fetch(basePath + 'harvey_quarterly_trends.json');
                trendsData = await trendsResponse.json();

                // Load org allocations
                const orgResponse = await fetch(basePath + 'harvey_org_allocations.csv');
                const orgText = await orgResponse.text();
                const orgData = d3.csvParse(orgText, d => ({
                    quarter: d.Quarter,
                    responsible_org: d.Organization,
                    program_type: d['Program Type'],
                    allocated: +d.Allocated,
                    activity_count: +d['Activity Count']
                }));

                // Load county allocations
                const countyResponse = await fetch(basePath + 'harvey_county_allocations.csv');
                const countyText = await countyResponse.text();
                const countyData = d3.csvParse(countyText, d => ({
                    quarter: d.Quarter,
                    county: d.County,
                    program_type: d['Program Type'],
                    allocated: +d.Allocated,
                    activity_count: +d['Activity Count']
                }));

                // Update stats from Sankey data
                if (sankeyData.summary) {
                    document.getElementById('total-budget').textContent = formatCurrency(sankeyData.summary.total_budget);
                    document.getElementById('current-quarter').textContent = sankeyData.quarter;
                }

                // Draw visualizations
                drawSankey(sankeyData);
                drawTimeline(trendsData, 'budget');
                drawCountyChart(countyData.filter(d => d.quarter === sankeyData.quarter));
                populateOrgTable(orgData.filter(d => d.quarter === sankeyData.quarter));

            } catch (error) {
                console.error('Error loading data:', error);
                d3.select('#sankey-chart').html('<p style="color: #c53030; padding: 2rem;">Error loading data. Please ensure the JSON/CSV export files are in the ../exports/ directory.</p>');
            }
        }

        // Handle window resize
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (sankeyData) drawSankey(sankeyData);
                if (trendsData) drawTimeline(trendsData, document.querySelector('.tab.active').dataset.view);
            }, 250);
        });

        // Initialize
        init();
    </script>
</body>
</html>
