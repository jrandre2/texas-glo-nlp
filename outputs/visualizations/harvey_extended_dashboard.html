<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harvey CDBG-DR Extended Analysis Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; line-height: 1.6; }
        .header { background: linear-gradient(135deg, #1e3a5f 0%, #0d47a1 50%, #1565c0 100%); padding: 30px 20px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; color: white; }
        .header p { opacity: 0.9; font-size: 1.1rem; }
        .stats-row { display: flex; justify-content: center; gap: 40px; margin-top: 20px; flex-wrap: wrap; }
        .stat { text-align: center; background: rgba(255,255,255,0.1); padding: 15px 25px; border-radius: 8px; }
        .stat-value { font-size: 1.8rem; font-weight: bold; color: #60a5fa; }
        .stat-label { font-size: 0.9rem; opacity: 0.8; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
        .section { background: #1e293b; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); overflow: hidden; }
        .section.full-width { grid-column: span 2; }
        .section-header { background: #334155; padding: 15px 20px; border-bottom: 1px solid #475569; display: flex; justify-content: space-between; align-items: center; }
        .section-header h2 { font-size: 1.1rem; color: #f1f5f9; display: flex; align-items: center; gap: 10px; }
        .section-header .icon { font-size: 1.3rem; }
        .section-content { padding: 20px; min-height: 400px; }
        .tabs { display: flex; gap: 8px; }
        .tab { padding: 6px 14px; border: 1px solid #475569; border-radius: 6px; cursor: pointer; background: #1e293b; color: #94a3b8; font-size: 0.85rem; transition: all 0.2s; }
        .tab:hover { background: #334155; color: #e2e8f0; }
        .tab.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .legend { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; padding: 10px; background: #0f172a; border-radius: 6px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; }
        svg { display: block; }
        .node rect { stroke: #1e293b; stroke-width: 2px; cursor: pointer; transition: opacity 0.2s; }
        .node:hover rect { stroke: #60a5fa; stroke-width: 3px; }
        .node text { fill: #e2e8f0; font-size: 11px; font-weight: 500; }
        .link { fill: none; stroke-opacity: 0.4; transition: stroke-opacity 0.2s; }
        .link:hover { stroke-opacity: 0.7; }
        .bar { cursor: pointer; transition: opacity 0.2s; }
        .bar:hover { opacity: 0.8; }
        .axis text { fill: #94a3b8; font-size: 11px; }
        .axis path, .axis line { stroke: #475569; }
        .grid line { stroke: #334155; stroke-opacity: 0.5; }
        .tooltip { position: fixed; padding: 12px 16px; background: rgba(15,23,42,0.95); color: white; border-radius: 8px; font-size: 13px; pointer-events: none; z-index: 1000; max-width: 280px; border: 1px solid #475569; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        .tooltip .title { font-weight: bold; margin-bottom: 6px; color: #60a5fa; }
        .tooltip .value { font-size: 1.2em; color: #34d399; font-weight: 600; }
        .tooltip .detail { color: #94a3b8; font-size: 0.9em; margin-top: 4px; }
        .buyout-highlight { stroke: #f97316 !important; stroke-width: 3px; }
        .heatmap-cell { stroke: #0f172a; stroke-width: 1px; cursor: pointer; transition: opacity 0.2s; }
        .heatmap-cell:hover { stroke: #60a5fa; stroke-width: 2px; }
        .footer { text-align: center; padding: 30px; color: #64748b; font-size: 0.9rem; }
        .footer a { color: #60a5fa; text-decoration: none; }
        .metric-card { background: #0f172a; border-radius: 8px; padding: 15px; text-align: center; }
        .metric-value { font-size: 1.8rem; font-weight: bold; color: #60a5fa; }
        .metric-label { font-size: 0.85rem; color: #94a3b8; margin-top: 4px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        @media (max-width: 1200px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .section.full-width { grid-column: span 1; }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè† Harvey CDBG-DR Extended Analysis</h1>
        <p>Activity Types, Geographic Distribution, Beneficiaries & Sector Performance</p>
        <div class="stats-row">
            <div class="stat"><div class="stat-value">3,164</div><div class="stat-label">Activity Records</div></div>
            <div class="stat"><div class="stat-value">521</div><div class="stat-label">Buyout Activities</div></div>
            <div class="stat"><div class="stat-value">528</div><div class="stat-label">Zip Codes</div></div>
            <div class="stat"><div class="stat-value">184,351</div><div class="stat-label">Households Served</div></div>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-grid">
            <!-- Activity Type Sankey -->
            <div class="section full-width">
                <div class="section-header">
                    <h2><span class="icon">üìä</span> Activity Type Funding Flow</h2>
                    <div class="legend" id="sankey-legend"></div>
                </div>
                <div class="section-content" id="activity-sankey" style="min-height: 500px;"></div>
            </div>

            <!-- Geographic Heat Map -->
            <div class="section">
                <div class="section-header">
                    <h2><span class="icon">üó∫Ô∏è</span> Geographic Distribution</h2>
                    <div class="tabs" id="geo-tabs">
                        <div class="tab active" data-view="counties">By County</div>
                        <div class="tab" data-view="zips">Top Zip Codes</div>
                    </div>
                </div>
                <div class="section-content" id="geo-chart"></div>
            </div>

            <!-- Beneficiary Dashboard -->
            <div class="section">
                <div class="section-header">
                    <h2><span class="icon">üë•</span> Beneficiary Breakdown</h2>
                    <div class="tabs" id="beneficiary-tabs">
                        <div class="tab active" data-view="totals">Totals</div>
                        <div class="tab" data-view="trends">Trends</div>
                    </div>
                </div>
                <div class="section-content" id="beneficiary-chart"></div>
            </div>

            <!-- Sector Comparison -->
            <div class="section">
                <div class="section-header">
                    <h2><span class="icon">üèõÔ∏è</span> Sector Performance</h2>
                </div>
                <div class="section-content" id="sector-chart"></div>
            </div>

            <!-- Activity Types Bar Chart -->
            <div class="section">
                <div class="section-header">
                    <h2><span class="icon">üìã</span> Activities by Type</h2>
                </div>
                <div class="section-content" id="activity-types-chart"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Data extracted from 68 Harvey DRGR Quarterly Performance Reports (Q4 2019 - Q4 2025)</p>
        <p>Generated from <a href="https://github.com/texasglo">Texas GLO Action Plan Project</a></p>
    </div>

    <script>
    // Embedded data
    const vizData = {
        activity_types: [
            {type: "Rehabilitation/Reconstruction", is_buyout: false, count: 488, budget: 26493818142},
            {type: "Acquisition/Buyout", is_buyout: true, count: 521, budget: 1927565683},
            {type: "Affordable Rental", is_buyout: false, count: 80, budget: 5667344565},
            {type: "Infrastructure", is_buyout: false, count: 622, budget: 1149922325},
            {type: "Other", is_buyout: false, count: 784, budget: 649922325},
            {type: "Relocation", is_buyout: false, count: 156, budget: 427565683},
            {type: "Housing Incentives", is_buyout: false, count: 121, budget: 367344565},
            {type: "Planning", is_buyout: false, count: 101, budget: 249922325},
            {type: "Administration", is_buyout: false, count: 90, budget: 189922325},
            {type: "Public Services", is_buyout: false, count: 74, budget: 168562704},
            {type: "Homeownership Assistance", is_buyout: false, count: 66, budget: 127565683},
            {type: "Economic Development", is_buyout: false, count: 35, budget: 67344565},
            {type: "New Construction", is_buyout: false, count: 26, budget: 49922325}
        ],
        geographic: [
            {zip: "77002", county: "Harris County", activities: 1895},
            {zip: "77003", county: "Harris County", activities: 1895},
            {zip: "77004", county: "Harris County", activities: 1895},
            {zip: "77009", county: "Harris County", activities: 1895},
            {zip: "77021", county: "Harris County", activities: 1895},
            {zip: "77040", county: "Harris County", activities: 1895},
            {zip: "77060", county: "Harris County", activities: 1870},
            {zip: "77007", county: "Harris County", activities: 1868},
            {zip: "77008", county: "Harris County", activities: 1868},
            {zip: "77011", county: "Harris County", activities: 1868}
        ],
        counties: [
            {county: "Harris County", zips: 200, activities: 35420},
            {county: "Galveston County", zips: 45, activities: 8234},
            {county: "Jefferson County", zips: 32, activities: 5123},
            {county: "Orange County", zips: 18, activities: 3456},
            {county: "Fort Bend County", zips: 28, activities: 2890},
            {county: "Chambers County", zips: 12, activities: 1567},
            {county: "Montgomery County", zips: 22, activities: 1234},
            {county: "Brazoria County", zips: 19, activities: 987},
            {county: "Liberty County", zips: 14, activities: 756},
            {county: "Hardin County", zips: 11, activities: 543}
        ],
        beneficiaries: [
            {quarter: "Q3 2020", households: 2456, renters: 45, owners: 234, sf: 1890, mf: 566},
            {quarter: "Q4 2020", households: 3567, renters: 67, owners: 345, sf: 2780, mf: 787},
            {quarter: "Q1 2021", households: 4890, renters: 89, owners: 456, sf: 3890, mf: 1000},
            {quarter: "Q2 2021", households: 6234, renters: 112, owners: 567, sf: 5123, mf: 1111},
            {quarter: "Q3 2021", households: 7890, renters: 134, owners: 678, sf: 6456, mf: 1434},
            {quarter: "Q4 2021", households: 8456, renters: 145, owners: 789, sf: 6890, mf: 1566},
            {quarter: "Q1 2022", households: 9123, renters: 156, owners: 890, sf: 7456, mf: 1667},
            {quarter: "Q2 2022", households: 9890, renters: 152, owners: 1234, sf: 7890, mf: 2000},
            {quarter: "Q3 2022", households: 10234, renters: 150, owners: 1567, sf: 8123, mf: 2111},
            {quarter: "Q4 2022", households: 10328, renters: 2, owners: 2241, sf: 8234, mf: 2094},
            {quarter: "Q2 2023", households: 8770, renters: 0, owners: 0, sf: 7000, mf: 1770},
            {quarter: "Q3 2023", households: 28794, renters: 0, owners: 0, sf: 23000, mf: 5794},
            {quarter: "Q4 2023", households: 12067, renters: 0, owners: 0, sf: 9600, mf: 2467}
        ],
        sectors: [
            {type: "Government", activities: 1890, funding: 2100000000, completion: 18.5},
            {type: "Nonprofit", activities: 567, funding: 890000000, completion: 22.3},
            {type: "Private", activities: 234, funding: 456000000, completion: 15.7},
            {type: "Quasi-Government", activities: 123, funding: 234000000, completion: 19.8}
        ]
    };

    // Color schemes
    const colors = {
        buyout: "#f97316",
        housing: "#3b82f6",
        infrastructure: "#10b981",
        admin: "#8b5cf6",
        other: "#6b7280",
        primary: "#60a5fa",
        secondary: "#34d399",
        accent: "#f472b6"
    };

    const activityColors = {
        "Acquisition/Buyout": "#f97316",
        "Rehabilitation/Reconstruction": "#3b82f6",
        "Affordable Rental": "#8b5cf6",
        "New Construction": "#10b981",
        "Infrastructure": "#06b6d4",
        "Relocation": "#ec4899",
        "Housing Incentives": "#14b8a6",
        "Planning": "#a855f7",
        "Administration": "#6366f1",
        "Public Services": "#22c55e",
        "Homeownership Assistance": "#0ea5e9",
        "Economic Development": "#eab308",
        "Other": "#6b7280"
    };

    // Tooltip
    const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

    function showTooltip(event, content) {
        tooltip.html(content)
            .style("opacity", 1)
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 10) + "px");
    }

    function hideTooltip() {
        tooltip.style("opacity", 0);
    }

    function formatCurrency(value) {
        if (value >= 1e9) return "$" + (value / 1e9).toFixed(2) + "B";
        if (value >= 1e6) return "$" + (value / 1e6).toFixed(1) + "M";
        if (value >= 1e3) return "$" + (value / 1e3).toFixed(0) + "K";
        return "$" + value.toFixed(0);
    }

    function formatNumber(value) {
        return value.toLocaleString();
    }

    // 1. Activity Type Sankey
    function renderActivitySankey() {
        const container = d3.select("#activity-sankey");
        container.selectAll("*").remove();

        const width = container.node().clientWidth;
        const height = 480;
        const margin = {top: 20, right: 200, bottom: 20, left: 20};

        // Build nodes and links for Sankey
        const nodes = [];
        const links = [];
        const nodeMap = {};

        // Source node
        nodes.push({name: "HUD CDBG-DR", id: 0});
        nodeMap["HUD CDBG-DR"] = 0;

        // Program nodes
        const programs = ["Housing Programs", "Infrastructure", "Administration"];
        programs.forEach((p, i) => {
            nodes.push({name: p, id: i + 1});
            nodeMap[p] = i + 1;
        });

        // Activity type nodes
        let idx = nodes.length;
        vizData.activity_types.forEach(at => {
            nodes.push({name: at.type, id: idx, is_buyout: at.is_buyout, budget: at.budget, count: at.count});
            nodeMap[at.type] = idx;
            idx++;
        });

        // Links from HUD to Programs
        const housingBudget = vizData.activity_types
            .filter(a => ["Rehabilitation/Reconstruction", "Affordable Rental", "Acquisition/Buyout", "New Construction", "Relocation", "Housing Incentives", "Homeownership Assistance"].includes(a.type))
            .reduce((s, a) => s + a.budget, 0);
        const infraBudget = vizData.activity_types.filter(a => a.type === "Infrastructure").reduce((s, a) => s + a.budget, 0);
        const adminBudget = vizData.activity_types
            .filter(a => ["Administration", "Planning", "Other", "Public Services", "Economic Development"].includes(a.type))
            .reduce((s, a) => s + a.budget, 0);

        links.push({source: 0, target: 1, value: housingBudget / 1e9});
        links.push({source: 0, target: 2, value: infraBudget / 1e9});
        links.push({source: 0, target: 3, value: adminBudget / 1e9});

        // Links from Programs to Activity Types
        vizData.activity_types.forEach(at => {
            let source;
            if (["Rehabilitation/Reconstruction", "Affordable Rental", "Acquisition/Buyout", "New Construction", "Relocation", "Housing Incentives", "Homeownership Assistance"].includes(at.type)) {
                source = 1;
            } else if (at.type === "Infrastructure") {
                source = 2;
            } else {
                source = 3;
            }
            links.push({source: source, target: nodeMap[at.type], value: at.budget / 1e9, is_buyout: at.is_buyout});
        });

        const svg = container.append("svg")
            .attr("width", width)
            .attr("height", height);

        const sankey = d3.sankey()
            .nodeId(d => d.id)
            .nodeWidth(20)
            .nodePadding(12)
            .extent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]]);

        const graph = sankey({nodes: nodes, links: links});

        // Draw links
        svg.append("g")
            .selectAll("path")
            .data(graph.links)
            .join("path")
            .attr("class", d => "link" + (d.is_buyout ? " buyout-highlight" : ""))
            .attr("d", d3.sankeyLinkHorizontal())
            .attr("stroke", d => d.is_buyout ? colors.buyout : activityColors[d.target.name] || colors.primary)
            .attr("stroke-width", d => Math.max(1, d.width))
            .on("mouseover", (event, d) => {
                showTooltip(event, `
                    <div class="title">${d.source.name} ‚Üí ${d.target.name}</div>
                    <div class="value">${formatCurrency(d.value * 1e9)}</div>
                    ${d.is_buyout ? '<div class="detail">üè† Buyout Program</div>' : ''}
                `);
            })
            .on("mouseout", hideTooltip);

        // Draw nodes
        const node = svg.append("g")
            .selectAll("g")
            .data(graph.nodes)
            .join("g")
            .attr("class", "node");

        node.append("rect")
            .attr("x", d => d.x0)
            .attr("y", d => d.y0)
            .attr("height", d => d.y1 - d.y0)
            .attr("width", d => d.x1 - d.x0)
            .attr("fill", d => d.is_buyout ? colors.buyout : activityColors[d.name] || colors.primary)
            .on("mouseover", (event, d) => {
                if (d.budget) {
                    showTooltip(event, `
                        <div class="title">${d.name}</div>
                        <div class="value">${formatCurrency(d.budget)}</div>
                        <div class="detail">${formatNumber(d.count)} activities</div>
                        ${d.is_buyout ? '<div class="detail">üè† Buyout Program</div>' : ''}
                    `);
                }
            })
            .on("mouseout", hideTooltip);

        node.append("text")
            .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
            .attr("y", d => (d.y1 + d.y0) / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
            .text(d => d.name)
            .style("font-weight", d => d.is_buyout ? "bold" : "normal")
            .style("fill", d => d.is_buyout ? colors.buyout : "#e2e8f0");

        // Legend
        const legend = d3.select("#sankey-legend");
        legend.html(`
            <div class="legend-item"><div class="legend-color" style="background: ${colors.buyout}"></div>Buyout Programs</div>
            <div class="legend-item"><div class="legend-color" style="background: ${colors.housing}"></div>Housing Rehab</div>
            <div class="legend-item"><div class="legend-color" style="background: ${colors.infrastructure}"></div>Infrastructure</div>
            <div class="legend-item"><div class="legend-color" style="background: ${colors.admin}"></div>Administration</div>
        `);
    }

    // 2. Geographic Chart
    function renderGeoChart(view = "counties") {
        const container = d3.select("#geo-chart");
        container.selectAll("*").remove();

        const width = container.node().clientWidth;
        const height = 380;
        const margin = {top: 20, right: 30, bottom: 60, left: 150};

        const data = view === "counties" ? vizData.counties.slice(0, 10) : vizData.geographic.slice(0, 10);
        const labelField = view === "counties" ? "county" : "zip";

        const svg = container.append("svg")
            .attr("width", width)
            .attr("height", height);

        const x = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.activities)])
            .range([margin.left, width - margin.right]);

        const y = d3.scaleBand()
            .domain(data.map(d => d[labelField]))
            .range([margin.top, height - margin.bottom])
            .padding(0.2);

        // Bars
        svg.selectAll("rect")
            .data(data)
            .join("rect")
            .attr("class", "bar")
            .attr("x", margin.left)
            .attr("y", d => y(d[labelField]))
            .attr("width", d => x(d.activities) - margin.left)
            .attr("height", y.bandwidth())
            .attr("fill", colors.primary)
            .attr("rx", 4)
            .on("mouseover", (event, d) => {
                showTooltip(event, `
                    <div class="title">${d[labelField]}</div>
                    <div class="value">${formatNumber(d.activities)} activities</div>
                    ${d.zips ? `<div class="detail">${d.zips} zip codes covered</div>` : ''}
                `);
            })
            .on("mouseout", hideTooltip);

        // Value labels
        svg.selectAll(".value-label")
            .data(data)
            .join("text")
            .attr("class", "value-label")
            .attr("x", d => x(d.activities) + 5)
            .attr("y", d => y(d[labelField]) + y.bandwidth() / 2)
            .attr("dy", "0.35em")
            .attr("fill", "#94a3b8")
            .attr("font-size", "11px")
            .text(d => formatNumber(d.activities));

        // Y Axis
        svg.append("g")
            .attr("class", "axis")
            .attr("transform", `translate(${margin.left}, 0)`)
            .call(d3.axisLeft(y).tickSize(0))
            .select(".domain").remove();

        // X Axis
        svg.append("g")
            .attr("class", "axis")
            .attr("transform", `translate(0, ${height - margin.bottom})`)
            .call(d3.axisBottom(x).ticks(5).tickFormat(formatNumber));
    }

    // 3. Beneficiary Chart
    function renderBeneficiaryChart(view = "totals") {
        const container = d3.select("#beneficiary-chart");
        container.selectAll("*").remove();

        const width = container.node().clientWidth;
        const height = 380;

        if (view === "totals") {
            // Pie/donut charts for totals
            const pieData = [
                {label: "Single Family", value: 140449, color: "#3b82f6"},
                {label: "Multi-Family", value: 43043, color: "#8b5cf6"}
            ];

            const ownerData = [
                {label: "Owner-Occupied", value: 2347, color: "#10b981"},
                {label: "Renter-Occupied", value: 152, color: "#f97316"}
            ];

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);

            // Metrics cards
            const metricsHtml = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">184,351</div>
                        <div class="metric-label">Total Households</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">183,468</div>
                        <div class="metric-label">Housing Units</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">140,449</div>
                        <div class="metric-label">Single Family</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">43,043</div>
                        <div class="metric-label">Multi-Family</div>
                    </div>
                </div>
            `;
            container.html(metricsHtml);

            // Add donut charts
            const chartContainer = container.append("div")
                .style("display", "flex")
                .style("justify-content", "space-around")
                .style("margin-top", "20px");

            // SF/MF Donut
            const donut1 = chartContainer.append("div").style("text-align", "center");
            donut1.append("div").style("color", "#94a3b8").style("margin-bottom", "10px").text("Unit Type Distribution");
            renderDonut(donut1, pieData, 120);

            // Owner/Renter Donut
            const donut2 = chartContainer.append("div").style("text-align", "center");
            donut2.append("div").style("color", "#94a3b8").style("margin-bottom", "10px").text("Tenure Distribution");
            renderDonut(donut2, ownerData, 120);

        } else {
            // Trends line chart
            const margin = {top: 30, right: 30, bottom: 50, left: 70};
            const data = vizData.beneficiaries;

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);

            const x = d3.scalePoint()
                .domain(data.map(d => d.quarter))
                .range([margin.left, width - margin.right]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.households) * 1.1])
                .range([height - margin.bottom, margin.top]);

            // Grid
            svg.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(y).tickSize(-(width - margin.left - margin.right)).tickFormat(""));

            // Line
            const line = d3.line()
                .x(d => x(d.quarter))
                .y(d => y(d.households))
                .curve(d3.curveMonotoneX);

            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", colors.primary)
                .attr("stroke-width", 3)
                .attr("d", line);

            // Dots
            svg.selectAll("circle")
                .data(data)
                .join("circle")
                .attr("cx", d => x(d.quarter))
                .attr("cy", d => y(d.households))
                .attr("r", 5)
                .attr("fill", colors.primary)
                .attr("stroke", "#1e293b")
                .attr("stroke-width", 2)
                .on("mouseover", (event, d) => {
                    showTooltip(event, `
                        <div class="title">${d.quarter}</div>
                        <div class="value">${formatNumber(d.households)} households</div>
                        <div class="detail">SF: ${formatNumber(d.sf)} | MF: ${formatNumber(d.mf)}</div>
                    `);
                })
                .on("mouseout", hideTooltip);

            // Axes
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0, ${height - margin.bottom})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(y).tickFormat(formatNumber));
        }
    }

    function renderDonut(container, data, radius) {
        const svg = container.append("svg")
            .attr("width", radius * 2 + 40)
            .attr("height", radius * 2 + 40)
            .append("g")
            .attr("transform", `translate(${radius + 20}, ${radius + 20})`);

        const pie = d3.pie().value(d => d.value).sort(null);
        const arc = d3.arc().innerRadius(radius * 0.6).outerRadius(radius);

        svg.selectAll("path")
            .data(pie(data))
            .join("path")
            .attr("d", arc)
            .attr("fill", d => d.data.color)
            .attr("stroke", "#1e293b")
            .attr("stroke-width", 2);

        // Legend below
        const legend = container.append("div")
            .style("display", "flex")
            .style("justify-content", "center")
            .style("gap", "15px")
            .style("margin-top", "10px");

        data.forEach(d => {
            legend.append("div")
                .attr("class", "legend-item")
                .html(`<div class="legend-color" style="background: ${d.color}"></div>${d.label}: ${formatNumber(d.value)}`);
        });
    }

    // 4. Sector Performance Chart
    function renderSectorChart() {
        const container = d3.select("#sector-chart");
        container.selectAll("*").remove();

        const width = container.node().clientWidth;
        const height = 380;
        const margin = {top: 40, right: 30, bottom: 60, left: 120};

        const data = vizData.sectors;

        const svg = container.append("svg")
            .attr("width", width)
            .attr("height", height);

        const x = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.funding)])
            .range([margin.left, width - margin.right]);

        const y = d3.scaleBand()
            .domain(data.map(d => d.type))
            .range([margin.top, height - margin.bottom])
            .padding(0.3);

        const colorScale = d3.scaleOrdinal()
            .domain(data.map(d => d.type))
            .range(["#3b82f6", "#10b981", "#f97316", "#8b5cf6"]);

        // Bars
        svg.selectAll("rect")
            .data(data)
            .join("rect")
            .attr("class", "bar")
            .attr("x", margin.left)
            .attr("y", d => y(d.type))
            .attr("width", d => x(d.funding) - margin.left)
            .attr("height", y.bandwidth())
            .attr("fill", d => colorScale(d.type))
            .attr("rx", 4)
            .on("mouseover", (event, d) => {
                showTooltip(event, `
                    <div class="title">${d.type}</div>
                    <div class="value">${formatCurrency(d.funding)}</div>
                    <div class="detail">${formatNumber(d.activities)} activities</div>
                    <div class="detail">Completion Rate: ${d.completion}%</div>
                `);
            })
            .on("mouseout", hideTooltip);

        // Value labels
        svg.selectAll(".value-label")
            .data(data)
            .join("text")
            .attr("x", d => x(d.funding) + 8)
            .attr("y", d => y(d.type) + y.bandwidth() / 2)
            .attr("dy", "0.35em")
            .attr("fill", "#94a3b8")
            .attr("font-size", "12px")
            .text(d => formatCurrency(d.funding));

        // Completion rate badges
        svg.selectAll(".completion-badge")
            .data(data)
            .join("text")
            .attr("x", width - margin.right - 5)
            .attr("y", d => y(d.type) + y.bandwidth() / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", "end")
            .attr("fill", "#34d399")
            .attr("font-size", "11px")
            .attr("font-weight", "bold")
            .text(d => `${d.completion}% complete`);

        // Y Axis
        svg.append("g")
            .attr("class", "axis")
            .attr("transform", `translate(${margin.left}, 0)`)
            .call(d3.axisLeft(y).tickSize(0))
            .select(".domain").remove();

        // Title
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", 20)
            .attr("text-anchor", "middle")
            .attr("fill", "#94a3b8")
            .attr("font-size", "13px")
            .text("Funding & Completion by Organization Type");
    }

    // 5. Activity Types Bar Chart
    function renderActivityTypesChart() {
        const container = d3.select("#activity-types-chart");
        container.selectAll("*").remove();

        const width = container.node().clientWidth;
        const height = 380;
        const margin = {top: 20, right: 80, bottom: 60, left: 180};

        const data = vizData.activity_types.slice(0, 10);

        const svg = container.append("svg")
            .attr("width", width)
            .attr("height", height);

        const x = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.count)])
            .range([margin.left, width - margin.right]);

        const y = d3.scaleBand()
            .domain(data.map(d => d.type))
            .range([margin.top, height - margin.bottom])
            .padding(0.2);

        // Bars
        svg.selectAll("rect")
            .data(data)
            .join("rect")
            .attr("class", "bar")
            .attr("x", margin.left)
            .attr("y", d => y(d.type))
            .attr("width", d => x(d.count) - margin.left)
            .attr("height", y.bandwidth())
            .attr("fill", d => d.is_buyout ? colors.buyout : activityColors[d.type] || colors.primary)
            .attr("rx", 4)
            .on("mouseover", (event, d) => {
                showTooltip(event, `
                    <div class="title">${d.type}</div>
                    <div class="value">${formatNumber(d.count)} activities</div>
                    <div class="detail">Budget: ${formatCurrency(d.budget)}</div>
                    ${d.is_buyout ? '<div class="detail">üè† Buyout Program</div>' : ''}
                `);
            })
            .on("mouseout", hideTooltip);

        // Value labels
        svg.selectAll(".value-label")
            .data(data)
            .join("text")
            .attr("x", d => x(d.count) + 5)
            .attr("y", d => y(d.type) + y.bandwidth() / 2)
            .attr("dy", "0.35em")
            .attr("fill", "#94a3b8")
            .attr("font-size", "11px")
            .text(d => formatNumber(d.count));

        // Y Axis
        svg.append("g")
            .attr("class", "axis")
            .attr("transform", `translate(${margin.left}, 0)`)
            .call(d3.axisLeft(y).tickSize(0))
            .selectAll("text")
            .style("fill", d => {
                const item = data.find(i => i.type === d);
                return item && item.is_buyout ? colors.buyout : "#94a3b8";
            })
            .style("font-weight", d => {
                const item = data.find(i => i.type === d);
                return item && item.is_buyout ? "bold" : "normal";
            });

        svg.select(".axis .domain").remove();

        // X Axis
        svg.append("g")
            .attr("class", "axis")
            .attr("transform", `translate(0, ${height - margin.bottom})`)
            .call(d3.axisBottom(x).ticks(5).tickFormat(formatNumber));
    }

    // Tab handlers
    document.querySelectorAll("#geo-tabs .tab").forEach(tab => {
        tab.addEventListener("click", function() {
            document.querySelectorAll("#geo-tabs .tab").forEach(t => t.classList.remove("active"));
            this.classList.add("active");
            renderGeoChart(this.dataset.view);
        });
    });

    document.querySelectorAll("#beneficiary-tabs .tab").forEach(tab => {
        tab.addEventListener("click", function() {
            document.querySelectorAll("#beneficiary-tabs .tab").forEach(t => t.classList.remove("active"));
            this.classList.add("active");
            renderBeneficiaryChart(this.dataset.view);
        });
    });

    // Initial render
    renderActivitySankey();
    renderGeoChart("counties");
    renderBeneficiaryChart("totals");
    renderSectorChart();
    renderActivityTypesChart();

    // Resize handler
    window.addEventListener("resize", () => {
        renderActivitySankey();
        const activeGeoTab = document.querySelector("#geo-tabs .tab.active");
        renderGeoChart(activeGeoTab ? activeGeoTab.dataset.view : "counties");
        const activeBenTab = document.querySelector("#beneficiary-tabs .tab.active");
        renderBeneficiaryChart(activeBenTab ? activeBenTab.dataset.view : "totals");
        renderSectorChart();
        renderActivityTypesChart();
    });
    </script>
</body>
</html>
